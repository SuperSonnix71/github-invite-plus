version: '3.8'

services:
  meilisearch:
    image: getmeili/meilisearch:v1.11
    container_name: gip-meilisearch
    restart: unless-stopped
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_ENV=production
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - gip-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:7700/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: gip-server
    restart: unless-stopped
    ports:
      - "8787:8787"
    environment:
      - NODE_ENV=production
      - PORT=8787
      - BASE_URL=${BASE_URL}
      - GITHUB_APP_CLIENT_ID=${GITHUB_APP_CLIENT_ID}
      - GITHUB_APP_CLIENT_SECRET=${GITHUB_APP_CLIENT_SECRET}
      - TOKEN_ENC_KEY_BASE64=${TOKEN_ENC_KEY_BASE64}
      - SESSION_SECRET=${SESSION_SECRET}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - MEILI_URL=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - INVITE_POLL_INTERVAL_SECONDS=${INVITE_POLL_INTERVAL_SECONDS:-180}
      - MAX_BLOB_BYTES=${MAX_BLOB_BYTES:-512000}
      - MAX_INDEX_FILES_PER_BRANCH=${MAX_INDEX_FILES_PER_BRANCH:-20000}
      - INDEX_CONCURRENCY=${INDEX_CONCURRENCY:-6}
      - API_RPM=${API_RPM:-240}
      - EXTENSION_REDIRECT_URI=${EXTENSION_REDIRECT_URI}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - DATABASE_PATH=/app/data/gip.sqlite
    volumes:
      - server_data:/app/data
    networks:
      - gip-network
    depends_on:
      meilisearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8787/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  meilisearch_data:
    driver: local
  server_data:
    driver: local

networks:
  gip-network:
    driver: bridge
